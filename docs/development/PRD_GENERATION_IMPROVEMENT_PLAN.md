# PRD 생성 기능 개선 계획

**작성일**: 2025년 1월 30일  
**목적**: PRD 생성 기능의 문제점 분석 및 개선 방안 제시

---

## 📋 문제점 분석

### 1. Mermaid 다이어그램 렌더링 문제

#### 문제 1-1: 다이어그램이 텍스트로만 표시됨
- **현상**: 첫 번째 Mermaid 다이어그램이 ` ```mermaid` 형식이 아닌 일반 코드 블록(` ``` `)으로 생성됨
- **원인**: 프롬프트에서 Mermaid 형식을 명시했지만, AI가 항상 정확히 따르지 않음
- **영향**: PRDViewer에서 Mermaid 다이어그램을 인식하지 못하여 텍스트로만 표시

#### 문제 1-2: 다이어그램이 잘리고 스크롤해야 보임
- **현상**: 두 번째 Mermaid 다이어그램이 화면에 잘려서 스크롤해야 전체를 볼 수 있음
- **원인**: 
  - 다이어그램 노드가 너무 많거나 텍스트가 너무 길어서 화면 크기를 초과
  - PRDViewer의 MermaidDiagram 컴포넌트에서 높이 계산이 제대로 되지 않음
- **영향**: 사용자가 다이어그램을 제대로 확인하기 어려움

#### 문제 1-3: 동일한 다이어그램이 중복 생성됨
- **현상**: 첫 번째와 두 번째 다이어그램이 동일한 내용
- **원인**: 중복 방지 로직이 제대로 작동하지 않음
- **영향**: 불필요한 중복으로 문서가 길어지고 혼란스러움

### 2. 문서 중복 문제

#### 문제 2-1: 섹션이 여러 번 반복됨
- **현상**: 같은 섹션(예: 프로젝트 개요, 사용자 스토리)이 여러 번 반복됨
- **원인**: 
  - 프롬프트에서 이전 부분을 참고하도록 했지만, AI가 제대로 따르지 않음
  - 이전 부분의 내용이 너무 길어서 (5000자 제한) 전체 내용을 파악하지 못함
- **영향**: 문서가 불필요하게 길어지고 가독성 저하

### 3. 문서 완성도 문제

#### 문제 3-1: 문서가 중간에 끊김
- **현상**: 문서 마지막이 "* 사용"처럼 불완전한 문장으로 끝남
- **원인**: 
  - 프롬프트에서 문서 완성도 확인 지시사항이 있지만, AI가 토큰 제한이나 다른 이유로 중간에 멈춤
  - 마지막 부분(Part 7 또는 Part 10)에서 완성도 확인이 제대로 이루어지지 않음
- **영향**: 문서가 불완전하여 사용자가 혼란스러움

---

## 🔧 개선 방안

### 1. Mermaid 다이어그램 개선

#### 개선 1-1: 프롬프트에서 Mermaid 형식 명확화
```typescript
// 개선 전
- 다이어그램은 간결하게 작성하여 화면에 잘 맞도록 하세요.

// 개선 후
- **⚠️ CRITICAL: Mermaid 다이어그램은 반드시 다음 형식을 정확히 따라야 합니다:**
  \`\`\`mermaid
  graph TB
      A[노드1] --> B[노드2]
  \`\`\`
- **절대 일반 코드 블록(\`\`\`)을 사용하지 마세요. 반드시 \`\`\`mermaid를 사용하세요.**
- 다이어그램 노드 텍스트는 최대 10자 이하로 작성하세요 (화면 잘림 방지).
- 다이어그램 노드는 최대 8개 이하로 작성하세요 (화면 크기 초과 방지).
- 다이어그램이 너무 복잡하면 여러 개로 나누어 작성하세요.
```

#### 개선 1-2: 다이어그램 크기 제한 강화
```typescript
// 프롬프트에 추가
- **다이어그램 크기 제한:**
  - 노드 개수: 최대 8개
  - 노드 텍스트: 최대 10자
  - 레벨(깊이): 최대 3단계
  - 이 제한을 초과하면 다이어그램을 여러 개로 나누어 작성하세요.
```

#### 개선 1-3: 중복 다이어그램 방지 강화
```typescript
// 프롬프트에 추가
- **⚠️ CRITICAL: 다이어그램 중복 방지:**
  - 이전 부분에 이미 작성된 다이어그램과 동일한 내용의 다이어그램을 작성하지 마세요.
  - 이전 부분의 다이어그램을 확인하고, 새로운 다이어그램만 작성하세요.
  - 다이어그램이 중복되면 해당 섹션을 건너뛰고 다음 섹션으로 진행하세요.
```

### 2. 문서 중복 방지 개선

#### 개선 2-1: 이전 부분 요약 제공
```typescript
// 개선 전: 이전 부분 전체 내용 (5000자 제한)
const previousContent = previousParts.map((p, i) => 
  `\n### Part ${i + 1} 전체 내용\n${p.substring(0, 5000)}...`
).join('\n\n---\n\n');

// 개선 후: 이전 부분 요약 + 섹션별 체크리스트
const previousContent = previousParts.map((p, i) => {
  // 섹션 추출 (정규식으로 마크다운 헤더 추출)
  const sections = extractSections(p);
  return `\n### Part ${i + 1} 작성된 섹션 목록\n${sections.map(s => `- ✅ ${s}`).join('\n')}\n\n**⚠️ 위 섹션들은 이미 작성되었으므로 다시 작성하지 마세요.**`;
}).join('\n\n---\n\n');
```

#### 개선 2-2: 섹션별 작성 가이드 명확화
```typescript
// 각 Part별로 작성할 섹션을 더 명확하게 지정
const sectionGuide = partNumber === 1 
  ? `- **Part 1 작성 내용**: 
      - ✅ 프로젝트 개요 섹션만 작성
      - ❌ 사용자 스토리, 기능 명세 등 다른 섹션은 작성하지 마세요
      - ❌ 프로젝트 개요 섹션을 여러 번 작성하지 마세요`
  : partNumber === 2
  ? `- **Part 2 작성 내용**: 
      - ✅ 사용자 스토리 섹션만 작성
      - ❌ 프로젝트 개요 섹션은 Part 1에 이미 있으므로 작성하지 마세요
      - ❌ 기능 명세 등 다른 섹션은 작성하지 마세요`
  : // ...
```

### 3. 문서 완성도 개선

#### 개선 3-1: 마지막 부분 완성도 확인 강화
```typescript
// Part 7 (마지막 부분) 프롬프트에 추가
const sectionGuide = partNumber === 7
  ? `- **Part 7 작성 내용**: 성공 지표 섹션만 상세히 작성하세요.
      - **⚠️ CRITICAL: 문서를 완전히 마무리하세요.**
      - 문서 마지막에 다음 중 하나로 자연스럽게 마무리하세요:
        1. "## 완료 조건" 섹션 추가
        2. "## 다음 단계" 섹션 추가
        3. "## 참고 자료" 섹션 추가
      - **절대 불완전한 문장으로 끝나면 안 됩니다.**
      - 마지막 문장은 반드시 완전한 문장이어야 합니다.
      - 마지막 문장 예시: "이 PRD 문서는 위 내용을 기반으로 개발을 진행할 수 있도록 작성되었습니다."
      - 마지막 문장 예시: "위 KPI를 기준으로 프로젝트의 성공 여부를 측정할 수 있습니다."`
  : '';
```

#### 개선 3-2: 문서 완성도 검증 로직 추가
```typescript
// generatePRD 메서드에 추가
private validatePRDCompleteness(prdContent: string): boolean {
  // 1. 마지막 문장이 완전한지 확인
  const lastSentence = prdContent.trim().split(/[.!?]\s*/).pop() || '';
  if (lastSentence.length < 10) {
    return false; // 너무 짧은 마지막 문장은 불완전한 것으로 간주
  }
  
  // 2. 마지막 문장이 불완전한 패턴인지 확인
  const incompletePatterns = [
    /^\* 사용$/,
    /^\* [가-힣]+$/,
    /^[가-힣]+$/,
    /^[가-힣]+ \*$/,
  ];
  
  for (const pattern of incompletePatterns) {
    if (pattern.test(lastSentence.trim())) {
      return false;
    }
  }
  
  return true;
}
```

---

## 📝 프롬프트 개선 사항 요약

### 1. Mermaid 다이어그램 관련
- ✅ ` ```mermaid` 형식을 반드시 사용하도록 명시
- ✅ 다이어그램 크기 제한 (노드 8개, 텍스트 10자, 레벨 3단계)
- ✅ 중복 다이어그램 방지 강화

### 2. 중복 방지 관련
- ✅ 이전 부분 요약 제공 (전체 내용 대신 섹션 목록)
- ✅ 섹션별 작성 가이드 명확화 (✅ 작성할 섹션, ❌ 작성하지 말 섹션)

### 3. 문서 완성도 관련
- ✅ 마지막 부분 완성도 확인 강화
- ✅ 문서 완성도 검증 로직 추가
- ✅ 불완전한 문장 패턴 감지

---

## 🎯 우선순위

### P0 (즉시 수정)
1. Mermaid 다이어그램 형식 명확화
2. 문서 완성도 확인 강화
3. 중복 방지 로직 개선

### P1 (다음 단계)
1. 문서 완성도 검증 로직 추가
2. 이전 부분 요약 제공
3. 섹션별 작성 가이드 명확화

### P2 (선택 사항)
1. 다이어그램 크기 자동 조정
2. 중복 내용 자동 제거
3. 문서 품질 점수 계산

---

## 📌 다음 단계

1. **프롬프트 수정**: `src/services/ai.ts`의 `buildPRDPrompt` 및 `buildPRDFromProposalPrompt` 메서드 수정
2. **검증 로직 추가**: `src/services/ai.ts`에 `validatePRDCompleteness` 메서드 추가
3. **테스트**: 수정된 프롬프트로 PRD 생성 테스트
4. **피드백 수집**: 사용자 피드백 수집 및 추가 개선

