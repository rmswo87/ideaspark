# PRD 생성 문제점 분석 및 개선 방안

**작성일**: 2025년 12월 3일  
**문제 발견**: 사용자 피드백

---

## 🔍 발견된 문제점

### 1. 중복 Mermaid 다이어그램 발생
**현상**: 같은 Mermaid 다이어그램이 여러 번 나타남  
**원인**: 
- AI가 이전 부분의 다이어그램을 확인하지 않고 새로 생성
- 중복 제거 로직이 정확한 매칭을 하지 못함
- 섹션별로 다이어그램을 생성하도록 지시되어 중복 발생

### 2. Mermaid 다이어그램이 잘림
**현상**: 다이어그램이 화면에 잘려서 스크롤해야 전체를 볼 수 있음  
**원인**:
- 노드 개수 제한(8개)이 지켜지지 않음
- 노드 텍스트 길이 제한(10자)이 지켜지지 않음
- 다이어그램 복잡도가 너무 높음

### 3. Mermaid 사이즈가 너무 큼
**현상**: 기본 테스트 사이즈에 비해 너무 크게 표시됨  
**원인**:
- 프롬프트의 크기 제한이 충분히 강조되지 않음
- AI가 크기 제한을 무시하고 복잡한 다이어그램 생성

### 4. 스크롤 발생 (직관적 표시 안 됨)
**현상**: 다이어그램 구조에서 스크롤이 발생하여 전체 구조를 한눈에 보기 어려움  
**원인**:
- 다이어그램이 너무 복잡함
- 레벨(깊이) 제한이 지켜지지 않음

### 5. 문서 구조 반복 및 숫자 뒤엉킴
**현상**: 같은 내용이 반복되고 섹션 번호가 뒤엉킴  
**원인**:
- 각 Part에서 이전 부분의 전체 내용을 참고하지만, 섹션별 체크리스트가 없음
- 섹션 번호 정규화 로직이 없음
- AI가 이전 부분의 섹션을 다시 작성

### 6. 문서 마무리 불완전
**현상**: 문서가 중간에 끊기거나 불완전한 문장으로 끝남  
**원인**:
- 마지막 Part에서 완성도 확인이 제대로 이루어지지 않음
- 토큰 제한으로 인해 중간에 멈춤
- 완성도 확인 로직이 약함

---

## 💡 개선 방안

### 방안 1: 프롬프트 개선 (권장)
**장점**: 
- 빠른 구현
- 기존 구조 유지
- AI가 더 정확하게 생성

**개선 사항**:
1. **섹션별 체크리스트 제공**
   - 이전 부분의 전체 내용 대신 작성된 섹션 목록만 제공
   - 각 Part별로 작성할 섹션 명확히 지정

2. **Mermaid 다이어그램 제한 강화**
   - 노드 개수: 최대 6개 (8개 → 6개로 축소)
   - 노드 텍스트: 최대 8자 (10자 → 8자로 축소)
   - 레벨: 최대 2단계 (3단계 → 2단계로 축소)
   - 다이어그램은 한 번만 작성 (Part 6에서만)

3. **섹션 번호 관리**
   - 각 Part별로 작성할 섹션 번호 명시
   - 섹션 번호 정규화 지시

4. **문서 완성도 확인 강화**
   - 마지막 Part에서 반드시 완성도 확인
   - 불완전한 문장 감지 및 수정 지시

### 방안 2: 병합 로직 개선
**장점**:
- 생성 후 정리 가능
- 더 정확한 중복 제거

**개선 사항**:
1. **섹션 번호 정규화**
   - 섹션 번호를 자동으로 정리
   - 중복 섹션 번호 제거

2. **Mermaid 다이어그램 중복 제거 강화**
   - 유사도 기반 중복 감지
   - 첫 번째 다이어그램만 유지

3. **문서 구조 정리**
   - 섹션 순서 정규화
   - 불완전한 섹션 제거

### 방안 3: 생성 방식 변경 (대규모 개편)
**장점**:
- 근본적인 문제 해결
- 더 일관된 문서 생성

**단점**:
- 큰 작업량
- 기존 코드 대폭 수정 필요

**변경 사항**:
- 10개 Part 방식 → 섹션별 단일 생성 방식
- 각 섹션을 독립적으로 생성 후 병합
- 섹션별 체크리스트 관리

---

## 🎯 추천 개선 순서

### 1단계: 프롬프트 개선 (즉시)
- 섹션별 체크리스트 제공
- Mermaid 제한 강화
- 섹션 번호 관리 명확화

### 2단계: 병합 로직 개선 (1-2일)
- 섹션 번호 정규화
- Mermaid 중복 제거 강화
- 문서 완성도 확인 강화

### 3단계: 생성 방식 변경 (필요 시, 1주)
- 섹션별 단일 생성 방식으로 전환
- 더 정확한 구조 관리

---

## 📝 구체적 개선 사항

### 프롬프트 개선

1. **이전 부분 요약 방식 변경**
```typescript
// 기존: 이전 부분 전체 내용 (5000자 제한)
const previousContent = previousParts.map((p, i) => 
  `\n### Part ${i + 1} 전체 내용\n${p.substring(0, 5000)}...`
).join('\n\n---\n\n');

// 개선: 작성된 섹션 목록만 제공
const previousSections = extractSections(previousParts);
const previousContent = `\n**⚠️ 이미 작성된 섹션 목록 (다시 작성하지 마세요):**\n${previousSections.map(s => `- ✅ ${s}`).join('\n')}`;
```

2. **Mermaid 다이어그램 제한 강화**
```typescript
// 프롬프트에 추가
- **⚠️ CRITICAL: Mermaid 다이어그램 크기 제한 (절대 준수):**
  - 노드 개수: 최대 6개 (초과 시 여러 개로 분리)
  - 노드 텍스트: 최대 8자 (한글 기준)
  - 레벨(깊이): 최대 2단계
  - 다이어그램은 Part 6에서만 한 번만 작성
  - 이전 부분에 이미 다이어그램이 있으면 새로 작성하지 마세요
```

3. **섹션 번호 관리**
```typescript
// 각 Part별로 작성할 섹션 명시
Part 1: ### 1. 프로젝트 개요만 작성
Part 2: ### 2. 사용자 스토리만 작성
Part 3: ### 3. 기능 명세만 작성
// ...
```

### 병합 로직 개선

1. **섹션 번호 정규화**
```typescript
// 섹션 번호를 자동으로 정리
merged = normalizeSectionNumbers(merged);
```

2. **Mermaid 중복 제거 강화**
```typescript
// 유사도 기반 중복 감지
const diagrams = extractAllMermaidDiagrams(merged);
const uniqueDiagrams = removeDuplicateDiagrams(diagrams);
```

3. **문서 완성도 확인**
```typescript
// 마지막 부분이 불완전하면 자동으로 마무리 문장 추가
if (isIncomplete(merged)) {
  merged += '\n\n---\n\n이 PRD 문서는 위 내용을 기반으로 개발을 진행할 수 있도록 작성되었습니다.';
}
```

---

**작성자**: AI Assistant  
**최종 업데이트**: 2025년 12월 3일

